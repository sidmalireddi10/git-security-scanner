name: Security & Compliance Scan

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
    inputs:
      severity-threshold:
        description: 'Minimum severity to fail the action'
        required: false
        default: 'high'
        type: choice
        options:
          - critical
          - high
          - medium
          - low
      scan-history:
        description: 'Number of commits to scan (0 to skip history)'
        required: false
        default: '10'
        type: string
      create-issues:
        description: 'Create issues for critical findings'
        required: false
        default: 'false'
        type: boolean

jobs:
  security-scan:
    name: Run Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit scanning
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Security Scanner
        id: scan
        env:
          SEVERITY_THRESHOLD: ${{ github.event.inputs.severity-threshold || 'high' }}
          SCAN_HISTORY: ${{ github.event.inputs.scan-history || '10' }}
        run: |
          cd scripts
          
          # Determine scan options
          if [ "$SCAN_HISTORY" != "0" ]; then
            HISTORY_FLAG="--history --commits $SCAN_HISTORY"
          else
            HISTORY_FLAG=""
          fi
          
          # Run the scan
          python main.py .. $HISTORY_FLAG --output-dir ../reports --severity-threshold $SEVERITY_THRESHOLD || echo "SCAN_FAILED=true" >> $GITHUB_OUTPUT
          
          # Set outputs
          if [ -f ../reports/security-report.json ]; then
            TOTAL_FINDINGS=$(python -c "import json; data=json.load(open('../reports/security-report.json')); print(data['statistics']['total_findings'])")
            CRITICAL_FINDINGS=$(python -c "import json; data=json.load(open('../reports/security-report.json')); print(data['statistics']['critical'])")
            
            echo "total_findings=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT
            echo "critical_findings=$CRITICAL_FINDINGS" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-reports
          path: reports/
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('reports/security-report.json')) {
              console.log('No report file found');
              return;
            }
            
            const report = JSON.parse(fs.readFileSync('reports/security-report.json', 'utf8'));
            const stats = report.statistics;
            
            let comment = '## ðŸ” Security Scan Results\n\n';
            
            if (stats.total_findings === 0) {
              comment += 'âœ… **No security or compliance issues found!**\n';
            } else {
              comment += `Found **${stats.total_findings}** potential issues:\n\n`;
              comment += `- ðŸ”´ Critical: ${stats.critical}\n`;
              comment += `- ðŸŸ  High: ${stats.high}\n`;
              comment += `- ðŸŸ¡ Medium: ${stats.medium}\n`;
              comment += `- ðŸ”µ Low: ${stats.low}\n\n`;
              
              if (stats.critical > 0 || stats.high > 0) {
                comment += 'âš ï¸ **Action Required:** Please review and address critical and high severity findings.\n\n';
              }
              
              comment += 'ðŸ“Š See the [detailed report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete information.\n';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Create Issues for Critical Findings
        if: github.event.inputs.create-issues == 'true' && steps.scan.outputs.critical_findings > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('reports/security-report.json', 'utf8'));
            
            const criticalFindings = report.findings.filter(f => f.severity === 'critical');
            
            for (const finding of criticalFindings.slice(0, 5)) {  // Limit to 5 issues
              const title = `ðŸ”´ Security: ${finding.name}`;
              let body = `**Severity:** Critical\n\n`;
              body += `**Description:** ${finding.description}\n\n`;
              
              if (finding.file) {
                body += `**File:** \`${finding.file}\`\n`;
              }
              if (finding.line) {
                body += `**Line:** ${finding.line}\n`;
              }
              
              body += `\n**Found by:** Security Scanner\n`;
              body += `**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'critical']
              });
            }
      
      - name: Check scan result
        if: steps.scan.outputs.SCAN_FAILED == 'true'
        run: |
          echo "Security scan failed due to severity threshold"
          exit 1
